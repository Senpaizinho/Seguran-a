<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Segurança do Trabalho - Situações</title>
  <style>
    :root{
      --bg: #eef6ff;
      --card: #fff;
      --primary: #2563eb;
      --accent: #f59e0b;
      --text: #0f172a;
      --radius: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:18px;
      min-height:100vh;
      align-items:flex-start;
    }
    .container{
      width:100%;
      max-width:1200px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    header{
      background:var(--card);
      padding:12px 16px;
      border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(16,24,40,0.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    h1{font-size:18px;margin:0}
    .controls { display:flex; gap:10px; align-items:center; }
    .btn{
      background:var(--primary);
      color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;
      font-weight:600; box-shadow: 0 6px 12px rgba(37,99,235,0.12);
    }
    .btn.ghost { background: transparent; color: var(--primary); border: 2px solid rgba(37,99,235,0.12); box-shadow:none; }
    .small { padding:6px 10px; font-size:14px; border-radius:8px; }

    .stage {
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      background: linear-gradient(180deg,#e8f3ff,#dbeefe);
      min-height:540px;
    }

    canvas{ display:block; width:100%; height:auto; background:transparent; transform-origin:center top; }

    /* animations */
    #gameCanvas.scene-enter { animation: sceneEnter 420ms cubic-bezier(.22,.9,.25,1) 1; }
    @keyframes sceneEnter {
      from { opacity: 0; transform: translateY(18px) scale(.985); filter: blur(4px) saturate(.95); }
      to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0) saturate(1); }
    }
    #gameCanvas.scene-fail { animation: sceneFail 520ms cubic-bezier(.36,.07,.19,.97) 1; }
    @keyframes sceneFail {
      0% { transform: translateX(0) rotate(0deg); } 10% { transform: translateX(-8px) rotate(-1deg); }
      25% { transform: translateX(10px) rotate(1deg); } 40% { transform: translateX(-6px) rotate(-0.6deg); }
      55% { transform: translateX(6px) rotate(0.6deg); } 70% { transform: translateX(-3px) rotate(-0.3deg); }
      85% { transform: translateX(2px) rotate(0.15deg); } 100% { transform: translateX(0) rotate(0deg); }
    }

    /* menu + rest kept as original */
    .menuOverlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(10,20,40,0.12); z-index: 30; pointer-events:auto; padding:20px; }
    .menuCard{ width:100%; max-width:1100px; background:var(--card); border-radius:14px; padding:16px; display:flex; gap:14px; box-shadow:0 18px 40px rgba(2,6,23,0.12); }
    .menuLeft{ width:42%; display:flex; flex-direction:column; gap:8px; }
    .menuRight{ width:58%; display:flex; flex-direction:column; gap:8px; }
    .missionList{ background:#f8fafc; border-radius:10px; padding:8px; max-height:420px; overflow:auto; border:1px solid rgba(16,24,40,0.04); }
    .missionItem{ display:flex; gap:10px; align-items:center; padding:10px; border-radius:8px; background: white; border:1px solid rgba(15,23,42,0.04); margin-bottom:8px; cursor:pointer; transition:transform .12s, box-shadow .12s; }
    .missionItem:hover{ transform:translateY(-4px); box-shadow:0 12px 30px rgba(2,6,23,0.06); }
    .missionThumb{ width:56px;height:56px;border-radius:8px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; }
    .missionTitle{ font-weight:800; font-size:14px; }
    .missionDesc{ color:#475569; font-size:13px; margin-top:4px; }

    .menuRight .previewCard { padding:12px; border-radius:10px; background:#f1f5f9; height:100%; overflow:auto; }
    .hidden { display:none !important; }

    .questionCard{ background:var(--card); padding:12px; border-radius:12px; box-shadow:0 8px 24px rgba(15,23,42,0.06); display:flex; gap:16px; align-items:flex-start; }
    .questionLeft{ width:68%; } .questionRight{ width:32%; min-width:220px; }
    .questionDifficulty{ font-size:12px; padding:4px 8px; border-radius:999px; display:inline-block; margin-left:8px; }
    .dif-easy{ background:#dcfce7; color:#166534; } .dif-medium{ background:#fff7ed; color:#92400e; } .dif-hard{ background:#fee2e2; color:#991b1b; }
    .options{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .optionBtn{ border-radius:10px; border:1px solid rgba(15,23,42,0.06); padding:10px; cursor:pointer; background:#fff; text-align:left; font-weight:600; transition: transform .08s ease, box-shadow .12s ease; }
    .optionBtn:hover{ transform:translateY(-3px); box-shadow:0 12px 30px rgba(2,6,23,0.06); }
    .feedback{ margin-top:8px; color:#0f172a; font-size:14px; min-height:44px; }
    .navScene{ position:absolute; right:14px; top:14px; z-index:40; display:flex; gap:8px; }
    .resultOverlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; background: linear-gradient(90deg, rgba(2,6,23,0.28), rgba(2,6,23,0.18)); opacity:0; pointer-events:none; transition:opacity .2s; }
    .resultOverlay.visible{ opacity:1; pointer-events:auto; } .resultCard{ background:#fff; padding:16px 18px; border-radius:10px; max-width:420px; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Segurança do Trabalho - Situações</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <div style="font-size:13px; color:#334;">Fase atual: <strong id="hudMission">—</strong></div>
        <div class="controls">
          <button class="btn" id="openMenuBtn">Fases</button>
          <button class="btn ghost small" id="resetBtn">Reiniciar cena</button>
        </div>
      </div>
    </header>

    <div class="stage" id="stage">
      <div id="menuOverlay" class="menuOverlay">
        <div class="menuCard" role="dialog" aria-label="Menu de fases">
          <div class="menuLeft">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div><div style="font-weight:800; font-size:18px;">Lista de fases</div></div>
            </div>
            <div class="missionList" id="missionList"></div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button class="btn small" id="btnPlaySelected">Jogar fase selecionada</button>
              <button class="btn ghost small" id="btnPlayFirst">Jogar Fase 1</button>
            </div>
          </div>
          <div class="menuRight">
            <div class="previewCard">
              <div style="font-weight:800;">Detalhes da fase</div>
              <div id="missionDetail" style="color:#475569; margin-top:8px; line-height:1.4;">Selecione uma fase para ver o enunciado e dificuldade.</div>
              <div style="margin-top:12px;">
                <div style="font-weight:700;">Como funciona</div>
                <div style="color:#6b7280; margin-top:6px; font-size:13px;">
                  Ao entrar em uma fase o menu fecha e você verá o cenário 2D animado. Escolha a melhor alternativa.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <canvas id="gameCanvas" width="1100" height="520" aria-label="Cena 2D"></canvas>

      <div class="navScene" id="navScene" style="display:none;">
        <button id="prevPhase" class="btn ghost small">◀ Anterior</button>
        <button id="backToMenu" class="btn ghost small">Menu</button>
        <button id="nextPhase" class="btn ghost small">Próxima ▶</button>
      </div>

      <div id="resultOverlay" class="resultOverlay" aria-hidden="true">
        <div class="resultCard" id="resultCard">
          <h3 id="resultTitle">Resultado</h3>
          <p id="resultText">...</p>
          <div style="display:flex; gap:8px; justify-content:center; margin-top:10px;">
            <button class="btn" id="resultRetry">Repetir</button>
            <button class="btn ghost" id="resultNext">Próxima</button>
            <button class="btn ghost" id="resultMenu">Voltar ao menu</button>
          </div>
        </div>
      </div>
    </div>

    <div class="questionCard" id="questionCard">
      <div class="questionLeft">
        <div style="font-size:15px; font-weight:800;">
          Situação
          <span id="questionDifficulty" class="questionDifficulty dif-easy">Fácil</span>
        </div>
        <div id="questionText" style="color:#334; margin-top:8px;">Selecione uma fase no menu.</div>
        <div class="options" id="optionsContainer" style="margin-top:8px;"></div>
        <div class="feedback" id="feedbackText">Aguardando escolha...</div>
      </div>

      <div class="questionRight">
        <div style="font-weight:800;">Instruções</div>
        <div style="color:#475569; margin-top:8px; font-size:13px;">
          - Clique numa fase.<br>- Escolha a alternativa correta.
        </div>
        <div style="margin-top:10px;">
          <div style="font-weight:700;">Atalhos</div>
          <div style="color:#475569; font-size:13px; margin-top:6px;">Teclas ← → para mudar fase | R para reiniciar cena</div>
        </div>
      </div>
    </div>

    <footer style="text-align:center; color:#475569; font-size:13px; margin-top:6px;">Criado por: Pedro Henrique e Emanuel Karllyson.</footer>
  </div>

<script>
/* ====== Dados das fases (mantidos) ====== */
const phases = [ /* mesma lista de 15 fases mantida — para brevidade não repetida visualmente no código mostrado */ ];

/* (Para não aumentar o tamanho do snippet visual repetindo tudo,
   o array `phases` será re-criado dinamicamente abaixo com os mesmos itens.) */
(function fillPhases(){
  const base = [
    ['Queda da Escada','Fácil','stairs','Um trabalhador caiu da escada dentro da empresa.',['Avaliar a cena para garantir que é seguro se aproximar.','Levantar o colega rapidamente.','Dar água e tentar colocar em pé.'],0],
    ['Esquecendo o EPI','Fácil','epi','Um funcionário vai entrar na área de obra sem capacete.',['Ignorar porque é rápido.','Emprestar um capacete quebrado.','Orientar a colocar o capacete antes de entrar.'],2],
    ['Corte Simples','Fácil','cut','Um trabalhador corta levemente a mão durante a atividade.',['Estancar o sangramento com proteção.','Mandar continuar o serviço.','Lavar com qualquer produto químico.'],0],
    ['Barulho Alto','Fácil','noise','Máquina com ruído muito acima do normal.',['Continuar usando tampões caseiros.','Gritar e seguir o trabalho.','Parar a máquina e comunicar a manutenção.'],2],
    ['Respirador Mal Ajustado','Fácil','respirator','Um trabalhador usa o respirador de forma errada.',['Tirar para trabalhar mais rápido.','Deixar assim mesmo.','Orientar e ajustar corretamente o respirador.'],2],
    ['Produto Químico Derramado','Média','chemical','Um frasco de produto químico derramou no chão.',['Limpar com pano comum.','Deixar secar sozinho.','Isolar a área e chamar o responsável.'],2],
    ['Fumaça no Lixo','Média','fire','Pequeno foco de incêndio no lixo.',['Usar o extintor adequado, se for seguro.','Jogar água sem verificar a causa.','Fugir sem avisar ninguém.'],0],
    ['Falta de EPC','Média','height','Trabalho em altura sem guarda-corpo.',['Interditar até instalar o guarda-corpo.','Continuar pois está quase acabando.','Só avisar para ter cuidado.'],0],
    ['Ferramenta Danificada','Média','tool','Funcionário tenta usar ferramenta quebrada.',['Retirar de uso e substituir.','Deixar usar só mais um pouco.','Ajeitar com fita improvisada.'],0],
    ['Poeira em Excesso','Média','dust','Ambiente com muita poeira em suspensão.',['Trabalhar sem máscara.','Usar respirador e acionar ventilação.','Jogar água no chão e continuar.'],1],
    ['Choque Elétrico','Difícil','shock','Um trabalhador sofreu choque elétrico e caiu.',['Desligar a energia antes de tocar.','Puxar a pessoa rapidamente.','Jogar água para acordar.'],0],
    ['Vazamento de Gás','Difícil','gas','Forte cheiro de gás no ambiente.',['Evacuar e acionar emergência.','Ligar a luz para ver melhor.','Abrir o fogão para confirmar.'],0],
    ['Risco Biológico','Difícil','bio','Contato com sangue em acidente.',['Usar EPI e encaminhar ao atendimento.','Limpar só com água.','Ignorar se for pouco.'],0],
    ['Estrutura Instável','Difícil','structure','Parede com rachaduras e risco de queda.',['Isolar a área e acionar engenharia.','Continuar afastado da parede.','Colocar fita e seguir.'],0],
    ['Incêndio em Equipamento Elétrico','Difícil','electricFire','Equipamento elétrico pegou fogo.',['Usar extintor classe C e cortar energia.','Jogar água.','Sair correndo sem avisar.'],0]
  ];
  window.phases = base.map((b,i)=>({
    id:'fase'+(i+1),
    title:b[0],
    difficulty:b[1],
    scene:b[2],
    situation:b[3],
    options: b[4].map((txt,j)=>({ t: txt, c: j===b[5], f: (j===b[5] ? 'Correto!' : 'Incorreto.')}))
  }));
})();

/* ====== DOM e canvas ====== */
const missionListEl = document.getElementById('missionList');
const missionDetailEl = document.getElementById('missionDetail');
const playSelectedBtn = document.getElementById('btnPlaySelected');
const btnPlayFirst = document.getElementById('btnPlayFirst');
const menuOverlay = document.getElementById('menuOverlay');
const openMenuBtn = document.getElementById('openMenuBtn');
const btnBackToMenu = document.getElementById('backToMenu');
const prevPhaseBtn = document.getElementById('prevPhase');
const nextPhaseBtn = document.getElementById('nextPhase');
const navScene = document.getElementById('navScene');

const questionText = document.getElementById('questionText');
const questionDifficulty = document.getElementById('questionDifficulty');
const optionsContainer = document.getElementById('optionsContainer');
const feedbackText = document.getElementById('feedbackText');

const gameCanvas = document.getElementById('gameCanvas');
const ctx = gameCanvas.getContext('2d');
let W = gameCanvas.width, H = gameCanvas.height;

const resultOverlay = document.getElementById('resultOverlay');
const resultTitle = document.getElementById('resultTitle');
const resultText = document.getElementById('resultText');
const resultRetry = document.getElementById('resultRetry');
const resultNext = document.getElementById('resultNext');
const resultMenu = document.getElementById('resultMenu');

const resetBtn = document.getElementById('resetBtn');

/* ====== Estado ====== */
let selectedIndex = 0;
let currentIndex = 0;
let inScene = false;
let animId = null;
let t = 0;
let phaseState = {};
let optionLocked = false;
let hudMission = document.getElementById('hudMission');

/* ====== Lista de fases (construção) ====== */
function makeThumbColor(i){
  const palette = ['#2563eb','#ef4444','#f59e0b','#16a34a','#7c3aed','#0ea5a4'];
  return palette[i % palette.length];
}
function buildMissionList(){
  missionListEl.innerHTML = '';
  window.phases.forEach((p,i) => {
    const item = document.createElement('div');
    item.className = 'missionItem';
    item.tabIndex = 0;
    item.dataset.index = i;
    const thumb = document.createElement('div');
    thumb.className = 'missionThumb';
    thumb.style.background = makeThumbColor(i);
    thumb.textContent = i+1;
    const info = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'missionTitle';
    title.textContent = p.title;
    const desc = document.createElement('div');
    desc.className = 'missionDesc';
    desc.textContent = p.situation;
    info.appendChild(title); info.appendChild(desc);
    item.appendChild(thumb); item.appendChild(info);
    item.addEventListener('click', () => { selectedIndex = i; openPhaseFromMenu(i); });
    item.addEventListener('keydown', (e) => { if(e.key==='Enter'){ selectedIndex=i; openPhaseFromMenu(i); }});
    missionListEl.appendChild(item);
  });
}
buildMissionList();

/* ====== Helpers UI ====== */
function updateMissionDetail(index){
  const p = window.phases[index];
  missionDetailEl.innerHTML = `<strong>${p.title}</strong><br><br><strong>Dificuldade:</strong> ${p.difficulty}<br><strong>Situação:</strong> ${p.situation}`;
}
missionListEl.addEventListener('mouseover', (e) => {
  const item = e.target.closest('.missionItem');
  if(item) updateMissionDetail(Number(item.dataset.index));
});

/* ====== Menu actions ====== */
function openMenu(){
  menuOverlay.style.display = 'flex';
  inScene = false;
  navScene.style.display = 'none';
  hudMission.textContent = '—';
  gameCanvas.classList.remove('scene-enter','scene-fail');
  if(animId) cancelAnimationFrame(animId);
}
openMenuBtn.addEventListener('click', openMenu);
function openPhaseFromMenu(index){
  menuOverlay.style.display = 'none';
  startPhase(index);
}
document.getElementById('btnPlaySelected').addEventListener('click', ()=> openPhaseFromMenu(selectedIndex || 0));
btnPlayFirst.addEventListener('click', ()=> openPhaseFromMenu(0));

btnBackToMenu.addEventListener('click', openMenu);
prevPhaseBtn.addEventListener('click', ()=> { if(currentIndex>0) startPhase(currentIndex-1); });
nextPhaseBtn.addEventListener('click', ()=> { if(currentIndex<window.phases.length-1) startPhase(currentIndex+1); });
document.addEventListener('keydown', (e)=> {
  if(inScene){
    if(e.key==='ArrowRight') { if(currentIndex < window.phases.length-1) startPhase(currentIndex+1); }
    if(e.key==='ArrowLeft') { if(currentIndex > 0) startPhase(currentIndex-1); }
    if(e.key.toLowerCase()==='r') resetPhaseState();
  }
});

/* ====== Preparar cena ====== */
function startPhase(index){
  currentIndex = index;
  inScene = true;
  optionLocked = false;
  t = 0;
  phaseState = createPhaseState(index);
  applyPhaseToUI(index);
  hudMission.textContent = window.phases[index].title;
  navScene.style.display = 'flex';

  gameCanvas.classList.remove('scene-enter');
  void gameCanvas.offsetWidth;
  gameCanvas.classList.add('scene-enter');
  const onEnterEnd = () => { gameCanvas.classList.remove('scene-enter'); gameCanvas.removeEventListener('animationend', onEnterEnd); };
  gameCanvas.addEventListener('animationend', onEnterEnd);

  if(animId) cancelAnimationFrame(animId);
  loop();
}

/* cria estado por fase (workers mais próximos e maiores) */
function createPhaseState(index){
  return {
    solved:false,
    failed:false,
    progress:0,
    shake:0,
    workers: createWorkersForScene(window.phases[index].scene),
    misc:{},
  };
}

/* aplica UI - pergunta, opções, dificuldade */
function applyPhaseToUI(index){
  const p = window.phases[index];
  questionText.textContent = p.situation;
  questionDifficulty.textContent = p.difficulty;
  questionDifficulty.className = 'questionDifficulty ' + (p.difficulty === 'Fácil' ? 'dif-easy' : (p.difficulty === 'Média' ? 'dif-medium' : 'dif-hard'));
  optionsContainer.innerHTML = '';
  p.options.forEach((opt,i) => {
    const btn = document.createElement('button');
    btn.className = 'optionBtn';
    btn.innerHTML = `<strong>${String.fromCharCode(65+i)})</strong> ${opt.t}`;
    btn.addEventListener('click', () => selectOption(i));
    optionsContainer.appendChild(btn);
  });
  feedbackText.textContent = 'Escolha a melhor alternativa.';
}

/* bloquear/desbloquear opções */
function lockOptions(){ optionLocked = true; [...optionsContainer.children].forEach(b=>b.disabled=true); }
function unlockOptions(){ optionLocked = false; [...optionsContainer.children].forEach(b=>b.disabled=false); }

/* selecionar opção */
function selectOption(idx){
  if(optionLocked) return;
  lockOptions();
  const p = window.phases[currentIndex];
  const opt = p.options[idx];
  feedbackText.textContent = opt.f;
  if(opt.c){
    phaseState.solved = true;
    phaseState.progress = 0;
    animSuccess();
    showResult(true, opt.f + ' ' + p.title);
  } else {
    phaseState.failed = true;
    animFail();
    const correct = p.options.find(o=>o.c).t;
    showResult(false, opt.f + ' Melhor: "' + correct + '".');
  }
}

/* mostrar overlay */
function showResult(isCorrect, text){
  resultOverlay.classList.add('visible');
  resultTitle.textContent = isCorrect ? 'Você acertou!' : 'Você errou!';
  resultText.textContent = text;
  resultOverlay.style.pointerEvents = 'auto';
  resultRetry.onclick = () => { resultOverlay.classList.remove('visible'); resetPhaseState(); };
  resultNext.onclick = () => { resultOverlay.classList.remove('visible'); if(isCorrect && currentIndex < window.phases.length-1) startPhase(currentIndex+1); else if(isCorrect) startPhase(currentIndex); else resetPhaseState(); };
  resultMenu.onclick = () => { resultOverlay.classList.remove('visible'); openMenu(); };
}

/* reiniciar estado da fase */
function resetPhaseState(){
  phaseState = createPhaseState(currentIndex);
  unlockOptions();
  feedbackText.textContent = 'Escolha a melhor alternativa.';
  gameCanvas.classList.remove('scene-fail','scene-enter');
}

/* animação sucesso/falha */
function animSuccess(){ phaseState.progress = 0; gameCanvas.style.transition = 'transform .18s ease'; gameCanvas.style.transform = 'scale(1.01)'; setTimeout(()=>{gameCanvas.style.transform=''; gameCanvas.style.transition='';},180); }
function animFail(){ phaseState.shake = 10; gameCanvas.classList.remove('scene-fail'); void gameCanvas.offsetWidth; gameCanvas.classList.add('scene-fail'); const onFailEnd = ()=>{ gameCanvas.classList.remove('scene-fail'); gameCanvas.removeEventListener('animationend', onFailEnd); }; gameCanvas.addEventListener('animationend', onFailEnd); setTimeout(()=>gameCanvas.classList.remove('scene-fail'),700); }

/* ====== Posicionamento: personagens mais juntos e maiores ====== */
function createWorkersForScene(scene){
  // Characters are placed close together near center-left so they are more visible.
  const centerX = W * 0.36;
  const baseY = H * 0.68;
  switch(scene){
    case 'stairs': return [
      {x: centerX+20, y: baseY+8, role:'victim', scale:1.15},
      {x: centerX-28, y: baseY+4, role:'helper', scale:1.15}
    ];
    case 'epi': return [
      {x: centerX+26, y: baseY+2, role:'no-helmet', scale:1.1},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.1}
    ];
    case 'cut': return [
      {x: centerX+18, y: baseY, role:'injured', scale:1.1},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.1}
    ];
    case 'noise': return [
      {x: centerX+20, y: baseY+2, role:'worker', scale:1.05},
      {x: centerX-30, y: baseY+4, role:'player', scale:1.05}
    ];
    case 'respirator': return [
      {x: centerX+22, y: baseY+2, role:'bad-mask', scale:1.1},
      {x: centerX-28, y: baseY+2, role:'player', scale:1.1}
    ];
    case 'chemical': return [
      {x: centerX+26, y: baseY+4, role:'spill', scale:1.05},
      {x: centerX-24, y: baseY+4, role:'player', scale:1.05}
    ];
    case 'fire': return [
      {x: centerX+24, y: baseY+6, role:'trash-fire', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    case 'height': return [
      {x: centerX+20, y: H*0.56, role:'worker-on-edge', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    case 'tool': return [
      {x: centerX+26, y: baseY+2, role:'broken-tool', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    case 'dust': return [
      {x: centerX+18, y: H*0.56, role:'dust-cloud', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    case 'shock': return [
      {x: centerX+18, y: baseY+2, role:'shocked', scale:1.05},
      {x: centerX-26, y: baseY-10, role:'panel', scale:1.0}
    ];
    case 'gas': return [
      {x: centerX+22, y: baseY+4, role:'gas-cloud', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    case 'bio': return [
      {x: centerX+20, y: baseY+4, role:'bio-spot', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    case 'structure': return [
      {x: centerX+22, y: H*0.52, role:'wall', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    case 'electricFire': return [
      {x: centerX+24, y: baseY+2, role:'electric-fire', scale:1.05},
      {x: centerX-26, y: baseY+2, role:'player', scale:1.05}
    ];
    default:
      return [{x:W*0.5,y:H*0.7,role:'worker',scale:1.0},{x:W*0.2,y:H*0.7,role:'player',scale:1.0}];
  }
}

/* ====== Desenho de personagens (mais detalhado, com scale) ====== */
function drawWorkerSimple(x, y, opts = {}){
  const color = opts.color || '#2563eb';
  const helmet = opts.helmet || false;
  const fallen = opts.fallen || false;
  const happy = opts.happy || false;
  const mask = opts.mask || false;
  const scale = opts.scale || 1.1;

  ctx.save();
  ctx.translate(x, y);

  // pequena sombra elíptica
  drawShadow(0, 16 * scale, 28 * scale, 10 * scale, 0.18);

  if(fallen){
    ctx.rotate(-Math.PI * 0.35);
    ctx.translate(-8*scale, 6*scale);
  }

  // corpo (com colete reflexivo)
  ctx.fillStyle = color;
  roundRect(ctx, -12*scale, -28*scale, 24*scale, 28*scale, 6*scale, true);
  // colete reflexivo
  ctx.fillStyle = 'rgba(255,255,255,0.12)';
  roundRect(ctx, -12*scale, -28*scale, 24*scale, 10*scale, 3*scale, true);
  ctx.fillStyle = '#fde047';
  ctx.fillRect(-10*scale, -18*scale, 20*scale, 6*scale); // faixa amarela

  // cabeça
  ctx.beginPath();
  ctx.fillStyle = '#fde68a';
  ctx.arc(0, -36*scale, 10*scale, 0, Math.PI*2);
  ctx.fill();

  // capacete
  if(helmet){
    ctx.fillStyle = '#facc15';
    ctx.beginPath();
    ctx.arc(0, -42*scale, 11*scale, Math.PI, 0);
    ctx.fill();
    ctx.fillRect(-11*scale, -42*scale, 22*scale, 5*scale);
    // sombra do capacete
    ctx.fillStyle = 'rgba(0,0,0,0.06)';
    ctx.fillRect(-9*scale, -38*scale, 18*scale, 2*scale);
  }

  // máscara
  if(mask){
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(-9*scale, -36*scale, 18*scale, 8*scale);
  }

  // rosto (olhos)
  ctx.fillStyle = '#111827';
  ctx.beginPath(); ctx.arc(-3*scale, -36*scale, 1.2*scale, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(3*scale, -36*scale, 1.2*scale, 0, Math.PI*2); ctx.fill();

  // boca (expressão)
  ctx.strokeStyle = '#111827';
  ctx.lineWidth = 1.2*scale;
  ctx.beginPath();
  if(happy){ ctx.arc(0, -32*scale, 4*scale, 0, Math.PI); }
  else { ctx.arc(0, -31*scale, 4*scale, Math.PI, 0); }
  ctx.stroke();

  // braços (mais definidos)
  ctx.strokeStyle = color;
  ctx.lineWidth = 4*scale;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(-10*scale, -18*scale); ctx.lineTo(-20*scale, -8*scale);
  ctx.moveTo(10*scale, -18*scale); ctx.lineTo(20*scale, -8*scale);
  ctx.stroke();

  // pernas
  ctx.strokeStyle = '#0f172a';
  ctx.lineWidth = 3*scale;
  ctx.beginPath();
  ctx.moveTo(-7*scale, -2*scale); ctx.lineTo(-7*scale, 12*scale);
  ctx.moveTo(7*scale, -2*scale); ctx.lineTo(7*scale, 12*scale);
  ctx.stroke();

  // detalhe: botinhas
  ctx.fillStyle = '#0f172a';
  roundRect(ctx, -11*scale, 12*scale, 10*scale, 6*scale, 2*scale, true);
  roundRect(ctx, 1*scale, 12*scale, 10*scale, 6*scale, 2*scale, true);

  ctx.restore();
}

function drawShadow(x,y,w,h,a=0.22){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle = `rgba(2,6,23,${a})`;
  ctx.beginPath();
  ctx.ellipse(0,0,w,h,0,0,Math.PI*2);
  ctx.fill();
  ctx.restore();
}

/* utility: rounded rect */
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  if(typeof r==='undefined') r=6;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if(fill){ ctx.fill(); }
  if(stroke){ ctx.stroke(); }
}

/* ====== Objetos do cenário (mais detalhados) ====== */
function drawCone(x,y,scale=1){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle = '#f59e0b';
  roundRect(ctx,-8*scale,-22*scale,16*scale,12*scale,3*scale,true);
  ctx.fillStyle = '#fff';
  ctx.fillRect(-6*scale,-14*scale,12*scale,4*scale);
  ctx.restore();
}
function drawToolbox(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle = '#9ca3af';
  roundRect(ctx,-26,-14,52,28,4,true);
  ctx.fillStyle = '#111827'; ctx.fillRect(-18,-6,12,6);
  ctx.fillStyle = '#ef4444';
  roundRect(ctx,-22,-12,14,8,3,true);
  ctx.restore();
}
function drawExtinguisher(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle = '#ef4444';
  roundRect(ctx,-6,-28,12,28,4,true);
  ctx.fillStyle = '#111827';
  ctx.fillRect(-2,-22,4,10);
  ctx.beginPath(); ctx.moveTo(6,-24); ctx.lineTo(14,-26); ctx.strokeStyle='#111827'; ctx.lineWidth=3; ctx.stroke();
  ctx.restore();
}
function drawGuardrail(x,y,w,h){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle = '#111827';
  ctx.fillRect(0,0,w,6);
  ctx.fillRect(0, -h/2, 6, h);
  ctx.fillRect(w-6, -h/2, 6, h);
  ctx.restore();
}
function drawCrack(x,y,w,h){
  ctx.save(); ctx.translate(x,y);
  ctx.strokeStyle = '#7f1d1d';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0,0);
  for(let i=0;i<6;i++) ctx.lineTo(Math.random()*w, h*(i/6));
  ctx.stroke();
  ctx.restore();
}
function drawGasCloud(x,y,alpha=0.35){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle = `rgba(148,163,184,${alpha})`;
  ctx.beginPath(); ctx.ellipse(0,0,44,22,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(28,6,24,14,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(-26,6,20,12,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
}
function drawSmoke(x,y,scale=1){
  ctx.save(); ctx.translate(x,y);
  for(let i=0;i<3;i++){
    ctx.fillStyle = `rgba(148,163,184,${0.12 + i*0.08})`;
    ctx.beginPath(); ctx.ellipse(i*12*scale, -i*8*scale, 18*scale, 10*scale, 0,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}
function drawBioSign(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle = '#fff'; roundRect(ctx,-14,-14,28,28,6,true);
  ctx.fillStyle = '#b91c1c'; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(0,-2,3,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

/* ====== Fundo base aprimorado ====== */
function drawBaseBackground(){
  // sky gradient
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#dbeafe'); g.addColorStop(1,'#eaf2ff');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // Sun glow
  ctx.beginPath(); ctx.fillStyle = 'rgba(255,250,220,0.55)'; ctx.ellipse(W*0.85, H*0.12, 90, 40, 0, 0, Math.PI*2); ctx.fill();

  // distant buildings with subtle windows
  ctx.fillStyle = '#c7d2fe'; ctx.fillRect(W*0.02, H*0.34, W*0.34, H*0.26);
  ctx.fillStyle = '#bbdefb'; ctx.fillRect(W*0.58, H*0.36, W*0.35, H*0.26);
  ctx.fillStyle = 'rgba(255,255,255,0.08)';
  for(let i=20;i<120;i+=20){
    ctx.fillRect(W*0.58 + (i-20), H*0.38, 6, 10);
  }

  // ground
  ctx.fillStyle = '#f1f5f9'; ctx.fillRect(0, H*0.62, W, H*0.38);

  // painted floor lines to guide attention
  ctx.fillStyle = '#e2e8f0'; ctx.fillRect(W*0.12, H*0.66, 2, 40);
  ctx.fillRect(W*0.18, H*0.66, 2, 40);
}

/* ====== Desenho de cada cena (melhorado) ====== */
function drawSceneIndex(idx){
  const p = window.phases[idx];
  drawBaseBackground();
  ctx.fillStyle = '#0f172a';
  ctx.font = '18px system-ui';
  ctx.fillText(p.title, 18, 30);
  switch(p.scene){
    case 'stairs': return drawSceneStairs();
    case 'epi': return drawSceneEpi();
    case 'cut': return drawSceneCut();
    case 'noise': return drawSceneNoise();
    case 'respirator': return drawSceneRespirator();
    case 'chemical': return drawSceneChemical();
    case 'fire': return drawSceneFire();
    case 'height': return drawSceneHeight();
    case 'tool': return drawSceneTool();
    case 'dust': return drawSceneDust();
    case 'shock': return drawSceneShock();
    case 'gas': return drawSceneGas();
    case 'bio': return drawSceneBio();
    case 'structure': return drawSceneStructure();
    case 'electricFire': return drawSceneElectricFire();
    default: return drawGeneric();
  }
}

/* ----- Scenes: mais objetos e personagens próximos ----- */
function drawSceneStairs(){
  // draw stairs bigger
  const sx = W*0.44, sy = H*0.74;
  ctx.strokeStyle = '#6b7280'; ctx.lineWidth = 4;
  for(let i=0;i<6;i++){
    ctx.beginPath();
    ctx.moveTo(sx + i*40, sy - i*18);
    ctx.lineTo(sx + 140 + i*40, sy - i*18);
    ctx.stroke();
  }
  // railing
  ctx.strokeStyle = '#111827'; ctx.lineWidth = 6;
  ctx.beginPath(); ctx.moveTo(sx+10, sy-20); ctx.lineTo(sx+260, sy-140); ctx.stroke();

  // nearby first-aid kit and cone
  drawToolbox(W*0.28, H*0.66);
  drawCone(W*0.32, H*0.7, 1);

  const victim = phaseState.workers[0] || {x:W*0.5,y:H*0.7,scale:1.1};
  const helper = phaseState.workers[1] || {x:W*0.44,y:H*0.7,scale:1.1};
  const wob = phaseState.shake ? Math.sin(t*60)*3 : 0;

  // draw characters close and larger
  drawWorkerSimple(helper.x + wob, helper.y, {color:'#2563eb', helmet:true, scale:helper.scale});
  drawWorkerSimple(victim.x + wob + 10, victim.y + 6, {color:'#ef4444', fallen:true, helmet:false, scale:victim.scale});
  if(phaseState.solved){
    drawWorkerSimple(helper.x+28, helper.y-28, {color:'#16a34a', helmet:true, happy:true, scale:1.1});
    ctx.fillStyle = 'rgba(34,197,94,0.08)'; ctx.fillRect(W*0.46, H*0.58, 60, 40);
  }
}

function drawSceneEpi(){
  // helmet rack
  roundRect(ctx, W*0.58, H*0.52, 240, 110, 8, true);
  // helmets on rack
  ctx.fillStyle = '#facc15'; roundRect(ctx, W*0.58+10, H*0.56, 48, 22, 6, true);
  ctx.fillStyle = '#ef4444'; roundRect(ctx, W*0.58+70, H*0.56, 48, 22, 6, true);
  ctx.fillStyle = '#60a5fa'; roundRect(ctx, W*0.58+130, H*0.56, 48, 22, 6, true);

  // characters together
  const a = phaseState.workers[0], b = phaseState.workers[1];
  drawWorkerSimple(b.x, b.y, {color:'#2563eb', helmet:true, scale:b.scale});
  drawWorkerSimple(a.x, a.y, {color:'#f97316', helmet:false, scale:a.scale});
  // instruction sign
  ctx.fillStyle = '#0f172a'; ctx.font='12px system-ui'; ctx.fillText('USE CAPACETE', W*0.58+6, H*0.52);
  if(phaseState.solved){
    drawWorkerSimple(a.x+28, a.y-8, {color:'#16a34a', helmet:true, happy:true, scale:1.05});
  }
}

function drawSceneCut(){
  // bench and toolbox
  roundRect(ctx, W*0.15, H*0.62, W*0.7, 18, 6, true);
  drawToolbox(W*0.38, H*0.64);
  // characters near each other
  const injured = phaseState.workers[0], player = phaseState.workers[1];
  drawWorkerSimple(player.x, player.y, {color:'#2563eb', helmet:true, scale:player.scale});
  if(phaseState.solved){
    drawWorkerSimple(injured.x, injured.y-8, {color:'#22c55e', helmet:true, happy:true, scale:injured.scale});
  } else {
    drawWorkerSimple(injured.x, injured.y, {color:'#ef4444', helmet:false, scale:injured.scale});
    // small blood spot
    ctx.fillStyle = '#b91c1c'; ctx.beginPath(); ctx.arc(injured.x+12, injured.y-22, 8, 0, Math.PI*2); ctx.fill();
  }
}

function drawSceneNoise(){
  // machine with sound waves and ear protection box
  roundRect(ctx, W*0.56, H*0.56, 180, 90, 8, true);
  ctx.fillStyle = '#ef4444'; ctx.font='12px system-ui'; ctx.fillText('MÁQUINA', W*0.6, H*0.56+6);
  drawToolbox(W*0.42, H*0.66);
  // characters together
  const a=phaseState.workers[0], b=phaseState.workers[1];
  drawWorkerSimple(b.x, b.y, {color:'#2563eb', helmet:true, scale:b.scale});
  drawWorkerSimple(a.x, a.y, {color: '#f97316', scale:a.scale});
  // sound waves
  const mx = W*0.62, my = H*0.52;
  const amp = phaseState.solved ? 6 : 18;
  ctx.strokeStyle = '#f97316'; ctx.lineWidth = 3;
  for(let i=0;i<3;i++){ ctx.beginPath(); ctx.arc(mx, my, amp + i*14 - (t%1)*4, -0.8, 0.8); ctx.stroke(); }
  if(phaseState.solved){
    ctx.fillStyle = 'rgba(34,197,94,0.08)'; ctx.fillRect(W*0.5, H*0.6, 40, 30);
  }
}

function drawSceneRespirator(){
  // contamination cloud and respirator station
  ctx.fillStyle = 'rgba(148,163,184,0.5)'; ctx.beginPath(); ctx.arc(W*0.68, H*0.56, 48, 0, Math.PI*2); ctx.fill();
  drawToolbox(W*0.46, H*0.66);
  const a = phaseState.workers[0], b = phaseState.workers[1];
  drawWorkerSimple(b.x, b.y, {color:'#2563eb', helmet:true, scale:b.scale});
  drawWorkerSimple(a.x, a.y, {color:'#f97316', mask:true, scale:a.scale});
  if(phaseState.solved){
    drawWorkerSimple(a.x+28, a.y-8, {color:'#16a34a', mask:true, happy:true, scale:1.05});
  }
}

function drawSceneChemical(){
  // spill pooled + neutralizer + cones
  ctx.fillStyle = '#bbf7d0'; ctx.beginPath(); ctx.ellipse(W*0.62, H*0.7, 80, 26, 0, 0, Math.PI*2); ctx.fill();
  roundRect(ctx, W*0.58, H*0.6-16, 20, 40, 6, true);
  drawCone(W*0.54, H*0.72, 1); drawCone(W*0.68, H*0.72, 1);
  // characters together
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color:'#f97316', scale:phaseState.workers[0].scale});
  if(phaseState.solved){
    ctx.fillStyle = '#f97316';
    for(let i=0;i<4;i++){
      ctx.beginPath();
      ctx.moveTo(W*0.5 + i*36, H*0.68);
      ctx.lineTo(W*0.52 + i*36, H*0.62);
      ctx.lineTo(W*0.54 + i*36, H*0.68);
      ctx.fill();
    }
  }
}

function drawSceneFire(){
  // trash bin fire + extinguisher + smoke
  roundRect(ctx, W*0.6, H*0.6-40, 44, 60, 6, true);
  const fx = W*0.62, fy = H*0.6-10;
  const fireH = 18 + Math.sin(t*8)*8;
  ctx.fillStyle = '#f97316';
  ctx.beginPath(); ctx.moveTo(fx, fy); ctx.quadraticCurveTo(fx+8, fy - fireH, fx+18, fy); ctx.quadraticCurveTo(fx+8, fy - (fireH*0.6), fx, fy); ctx.fill();
  drawExtinguisher(W*0.6, H*0.6-20);
  drawSmoke(W*0.64, H*0.56, 1);
  // characters together
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color:'#ef4444', scale:phaseState.workers[0].scale});
  if(phaseState.solved){
    phaseState.progress = Math.min(1, phaseState.progress + 0.03);
    ctx.fillStyle = `rgba(148,163,184,${1-phaseState.progress})`;
    ctx.fillRect(fx-20, fy-40, 80, 60);
    drawWorkerSimple(phaseState.workers[1].x+24, phaseState.workers[1].y-16, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawSceneHeight(){
  // missing guardrail vs installed
  roundRect(ctx, W*0.55, H*0.48, 160, 12, 4, true);
  drawGuardrail(W*0.55, H*0.48-10, 24, 60);
  // group characters near edge
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color:'#ef4444', scale:phaseState.workers[0].scale});
  if(phaseState.solved){
    ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 6;
    ctx.beginPath(); ctx.moveTo(W*0.55, H*0.48); ctx.lineTo(W*0.72, H*0.36); ctx.stroke();
    drawWorkerSimple(phaseState.workers[1].x+28, phaseState.workers[1].y-20, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawSceneTool(){
  roundRect(ctx, W*0.2, H*0.6, W*0.6, 18, 6, true);
  drawToolbox(W*0.6, H*0.58);
  // characters close by
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color: phaseState.solved? '#22c55e' : '#ef4444', scale:phaseState.workers[0].scale});
}

function drawSceneDust(){
  // swirling dust and extractor
  for(let i=0;i<40;i++){
    const x = W*0.45 + Math.cos(t*2 + i)*80 * (i%5/5);
    const y = H*0.48 + (i%10)*8;
    ctx.fillStyle = 'rgba(148,163,184,0.45)';
    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
  }
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color:'#f97316', scale:phaseState.workers[0].scale});
  if(phaseState.solved){
    drawWorkerSimple(phaseState.workers[1].x+28, phaseState.workers[1].y-18, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawSceneShock(){
  // electric panel + sparks + fallen person
  roundRect(ctx, W*0.64, H*0.46, 80, 110, 6, true);
  ctx.fillStyle = '#facc15'; ctx.fillRect(W*0.69, H*0.5, 8, 20);
  // sparks
  ctx.strokeStyle='#f97316'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(W*0.58, H*0.64); ctx.lineTo(W*0.6, H*0.6); ctx.lineTo(W*0.62, H*0.66); ctx.stroke();
  // characters: fallen and helper close by
  drawFallenWorkerVisual(phaseState.workers[0].x, phaseState.workers[0].y);
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  if(phaseState.solved){
    ctx.fillStyle = '#94a3b8'; roundRect(ctx, W*0.64, H*0.46, 80, 110, 6, true);
    drawWorkerSimple(phaseState.workers[1].x+28, phaseState.workers[1].y-18, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawFallenWorkerVisual(x,y){
  ctx.save(); ctx.translate(x,y); ctx.rotate(-Math.PI*0.6);
  drawWorkerSimple(0,0,{color:'#ef4444', fallen:true, scale:1.05});
  ctx.restore();
}

function drawSceneGas(){
  drawGasCloud(W*0.66, H*0.6, 0.42);
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color:'#f97316', scale:phaseState.workers[0].scale});
  if(phaseState.solved){
    phaseState.progress = Math.min(1, phaseState.progress + 0.02);
    drawWorkerSimple(phaseState.workers[1].x+22, phaseState.workers[1].y-14, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawSceneBio(){
  drawBioSign(W*0.5, H*0.66);
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color:'#ef4444', scale:phaseState.workers[0].scale});
  if(phaseState.solved){
    drawWorkerSimple(phaseState.workers[1].x+28, phaseState.workers[1].y-18, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawSceneStructure(){
  // wall with cracks and cones
  ctx.fillStyle = '#cbd5f5'; roundRect(ctx, W*0.54, H*0.38, 180, 170, 8, true);
  drawCrack(W*0.6, H*0.44, 40, 120);
  drawCone(W*0.56, H*0.74, 1); drawCone(W*0.7, H*0.74, 1);
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  if(phaseState.solved){
    ctx.strokeStyle = '#f97316'; ctx.setLineDash([8,6]); ctx.strokeRect(W*0.52, H*0.36, 200, 190); ctx.setLineDash([]);
    drawWorkerSimple(phaseState.workers[1].x+28, phaseState.workers[1].y-18, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawSceneElectricFire(){
  roundRect(ctx, W*0.6, H*0.54, 90, 70, 8, true);
  ctx.fillStyle = '#f97316';
  ctx.beginPath();
  ctx.moveTo(W*0.62, H*0.56);
  ctx.quadraticCurveTo(W*0.66, H*0.48, W*0.7, H*0.56);
  ctx.fill();
  drawExtinguisher(W*0.5, H*0.56);
  drawWorkerSimple(phaseState.workers[1].x, phaseState.workers[1].y, {color:'#2563eb', scale:phaseState.workers[1].scale});
  drawWorkerSimple(phaseState.workers[0].x, phaseState.workers[0].y, {color:'#ef4444', scale:phaseState.workers[0].scale});
  if(phaseState.solved){
    phaseState.progress = Math.min(1, phaseState.progress + 0.02);
    roundRect(ctx, W*0.5, H*0.56, 26, 44, 6, true);
    drawWorkerSimple(phaseState.workers[1].x+28, phaseState.workers[1].y-18, {color:'#16a34a', happy:true, scale:1.05});
  }
}

function drawGeneric(){
  drawWorkerSimple(playerVisualX(), playerVisualY(), {color:'#2563eb', scale:1.05});
}

/* util */
function playerVisualX(){ return W*0.18; }
function playerVisualY(){ return H*0.7; }
function lerp(a,b,t){ return a + (b-a)*t; }

/* ====== Loop ====== */
function loop(){
  t += 0.016;
  ctx.clearRect(0,0,W,H);
  drawSceneIndex(currentIndex);
  if(phaseState.shake){ phaseState.shake *= 0.92; if(phaseState.shake < 0.05) phaseState.shake = 0; }
  animId = requestAnimationFrame(loop);
}

/* ====== Inicialização e listeners ====== */
function init(){
  updateMissionDetail(0);
  const items = missionListEl.querySelectorAll('.missionItem');
  if(items[0]) items[0].classList.add('selected');
}
init();

resetBtn.addEventListener('click', resetPhaseState);
resultRetry.addEventListener('click', ()=>{ resultOverlay.classList.remove('visible'); resetPhaseState(); });
resultNext.addEventListener('click', ()=>{ resultOverlay.classList.remove('visible'); if(currentIndex < window.phases.length - 1) startPhase(currentIndex+1); });
resultMenu.addEventListener('click', ()=>{ resultOverlay.classList.remove('visible'); openMenu(); });

/* Start with menu open */
openMenu();

</script>
</body>
</html>
